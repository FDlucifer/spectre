#include "headers.h"

int tracer_func( int process_index, state_t state )
{
   if ( state == EXITING )
   {
      for ( int i = 0 ; i < MAX_TRACEABLE_HOSTS ; i++ )
      {
         if ( systems[ current_system( ) ].
                  traceable_hosts.ip_address[ i ][ 0 ] )
         {
            add_message( &systems[ current_system( ) ].
                           traceable_hosts.ip_address[ i ][ 0 ] );
         }
      }

      // Indicate that the process has exited.
      return 1;
   }

   // Indicate that the process is still running.
   return 0;
}

int sleeper_func( int process_index, state_t state )
{
   if ( state == EXITING )
   {
      int target_process_index = find_process( 
            systems[ current_system( ) ].processes.process[ process_index ].argument );

      if ( target_process_index != -1 )
      {
         int exploit_process_strength = systems[ current_system( ) ].processes.
               process[ process_index ].strength;
         int target_process_strength = systems[ current_system( ) ].processes.
               process[ target_process_index ].strength;

         if ( exploit_process_strength > target_process_strength )
         {
            systems[ current_system( ) ].processes.
                  process[ target_process_index ].state = SLEEPING;
            systems[ current_system( ) ].processes.
                  process[ target_process_index ].state_value = 7000;
         }
      }

      // Process has exited.
      return 1;
   }
   else
   {
      return 0;
   }
}

int drone_gps_func( int process_index, state_t state )
{
   static float lat = 40.715372;
   static float lng = -73.99813;
   static float alt = 800.0;
   int proc = find_process( 536 );

   lat += ( ( ( float ) getRand( 100 ) - ( float ) 50 ) / 10000.0 );
   lng += ( ( ( float ) getRand( 120 ) - ( float ) 60 ) / 10000.0 );

   int file_index = find_file( current_system( ), "geolocation" );

   if ( proc != -1 )
   {
      // Flying...
      alt += ( ( ( float ) getRand( 10 ) - ( float ) 5 ) / 100.0 );
   }
   else
   {
      alt -= 20.0;

      if ( alt <= 0.0 )
      {
         systems[ current_system( ) ].flags.alive = 0;
         set_current_system( pop_system( ) );
         add_message( "Connection terminated." );
         add_chat_message( "" );
         add_chat_message( "That made quite a mess..." );
         return 1;
      }

   }

   sprintf( systems[ current_system( ) ].filesystem.files[ file_index].contents,
             "%4.8f, %4.7f, %3.2f\n", lat, lng, alt );

   return 0;
}

int datatap_func( int process_index, state_t state )
{
   // Attaches to a process and emits any available data about it.
   // Operates in stealth and under scanners or sentries.

   return 1;
}

